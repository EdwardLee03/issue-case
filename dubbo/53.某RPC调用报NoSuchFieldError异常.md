

某RPC调用报NoSuchFieldError异常
=========================
> 2019-07-26


## 1.认识问题
点石同学于7-2上午反馈收到运维的Exception告警信息，希望协助排查。

```
应用switch-spo-spring-boot-starter，于2019-07-01 20:05:46，第1次发现java.lang.NoSuchFieldError异常，traceId=0a01117315619827412617624，异常源于节点[xxx]，服务[OpenUserService.filterUser]。[production]
```


## 2.分析问题
从**告警信息**得到一些线索，第一是`NoSuchFieldError`异常，第二是链路追踪`traceId=0a01117315619827412617624`。

`NoSuchFieldError`异常表示该对象不拥有该字段，判断不出这个异常是从提供者还是消费者抛出来的，需要结合**调用栈**才能进一步确认。
```java
/**
 * Thrown if an application tries to access or modify a specified
 * field of an object, and that object no longer has that field.
 * <p>
 * Normally, this error is caught by the compiler; this error can
 * only occur at run time if the definition of a class has
 * incompatibly changed.
 */
public class NoSuchFieldError extends IncompatibleClassChangeError {
```

希望通过链路追踪`traceId=0a01117315619827412617624`能追踪到**调用栈**，运气不错，发现了一些有价值的线索。从链路跟踪数据里知道是 `open-normandy-api` 提供者应用抛出了`NoSuchFieldError`异常，详细的异常堆栈也能看到。(见附件1)
http://cloud.xxx.info/scale/call-link-detail?traceId=0a01117315619827412617624

```java
com.xxx.loan.service.impl.RateServiceImpl.fillRepaymentInfo(RateServiceImpl.java:240)
com.xxx.loan.service.impl.RateServiceImpl.lambda$null$2(RateServiceImpl.java:185)
java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1374)
java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
com.xxx.loan.service.impl.RateServiceImpl.lambda$calculateFeeLimit$3(RateServiceImpl.java:169)
java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1374)
java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
com.xxx.loan.service.impl.RateServiceImpl.calculateFeeLimit(RateServiceImpl.java:165)
com.xxx.loan.service.user.impl.UserCreditServiceImpl.updateUserCredit(UserCreditServiceImpl.java:184)
com.xxx.loan.service.user.impl.UserCreditServiceImpl.queryUserCredit(UserCreditServiceImpl.java:80)
......
```

在通过日志平台里的 `open-normandy-api` 应用日志确认了，但由于对业务不了解，让@君度找相关负责人解决。
[http://logs.xxx.info/app/kibana#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-1d%2Fd,mode:quick,to:now-1d%2Fd))&_a=(columns:!(_source),index:'w-open-normandy-api-*',interval:auto,query:(query_string:(query:'*NoSuchField*')),sort:!('@timestamp',desc))]
```java
[] [a34fb958717925cf] [bds=]  [DUBBO] Got unchecked and undeclared exception which called by xxx. service: com.xxx.loan.client.service.OpenUserService, method: filterUser, exception: java.lang.NoSuchFieldError: AHEAD_AVERAGE_CAPITAL_PLUS_INTEREST_P2P, dubbo version: 3.2.8.2, current host: xxx
java.lang.NoSuchFieldError: AHEAD_AVERAGE_CAPITAL_PLUS_INTEREST_P2P
	at com.xxx.loan.service.impl.RateServiceImpl.fillRepaymentInfo(RateServiceImpl.java:240)
	at com.xxx.loan.service.impl.RateServiceImpl.lambda$null$2(RateServiceImpl.java:185)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1374)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at com.xxx.loan.service.impl.RateServiceImpl.lambda$calculateFeeLimit$3(RateServiceImpl.java:169)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1374)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at com.xxx.loan.service.impl.RateServiceImpl.calculateFeeLimit(RateServiceImpl.java:165)
	at com.xxx.loan.service.user.impl.UserCreditServiceImpl.updateUserCredit(UserCreditServiceImpl.java:184)
	at com.xxx.loan.service.user.impl.UserCreditServiceImpl.queryUserCredit(UserCreditServiceImpl.java:80)
.....
```

